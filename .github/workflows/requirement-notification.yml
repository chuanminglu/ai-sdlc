name: 需求变更邮件通知

# 触发条件：当Issue被创建、编辑、标签变更或重新打开时
on:
  issues:
    types: [opened, edited, labeled, unlabeled, reopened]

permissions:
  contents: read    # 用于读取仓库内容
  issues: write     # 用于创建和评论Issue
  pull-requests: read # 用于读取仓库元数据
  repository-projects: write # 用于管理项目

# GitHub Secrets 配置说明：
# 1. EMAIL_USERNAME: 你的QQ邮箱地址（52148@qq.com）
# 2. EMAIL_PASSWORD: 你的QQ邮箱授权码，不是QQ密码
#    获取QQ邮箱授权码步骤：
#    - 登录QQ邮箱网页版
#    - 点击"设置" -> "账户"
#    - 找到"POP3/SMTP服务"并开启
#    - 按提示生成授权码并保存

jobs:
  notify-requirement-change:
    runs-on: ubuntu-latest
    
    # 仅当Issue包含"requirement"或"feature"标签时运行
    if: contains(github.event.issue.labels.*.name, 'requirement') || contains(github.event.issue.labels.*.name, 'feature')
    
    steps:
      # 步骤1: 发送邮件通知
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          to: 52148@qq.com
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          subject: 🔔 需求变更通知：${{ github.event.issue.title }}
          html_body: |
            <h2>需求变更通知</h2>
            <p><strong>状态：</strong> 
            ${{ github.event.action == 'opened' && '新增需求' ||
                github.event.action == 'edited' && '需求已编辑' ||
                github.event.action == 'labeled' && '需求新增标签' ||
                github.event.action == 'unlabeled' && '需求移除标签' ||
                github.event.action == 'reopened' && '需求重新打开' ||
                '需求已更新' }}
            </p>
            <p><strong>标题：</strong> ${{ github.event.issue.title }}</p>
            <p><strong>编号：</strong> #${{ github.event.issue.number }}</p>
            <p><strong>提交者：</strong> ${{ github.event.issue.user.login }}</p>
            <p><strong>标签：</strong> ${{ join(github.event.issue.labels.*.name, ', ') }}</p>
            <h3>需求描述：</h3>
            <pre>
            ${{ github.event.issue.body }}
            </pre>
            <p><a href="${{ github.event.issue.html_url }}">查看详情</a></p>
      
      # 步骤2: 更新项目看板（使用新版 GitHub Projects API）
      - name: Update project board
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_PAT }}  # 使用具有更高权限的个人访问令牌
          script: |
            async function run() {
              try {
                // 首先获取用户的节点ID
                const userQuery = await github.graphql(`
                  query($owner: String!) {
                    user(login: $owner) {
                      id
                      projectsV2(first: 20) {
                        nodes {
                          id
                          title
                          number
                        }
                      }
                    }
                  }
                `, {
                  owner: context.repo.owner
                });

                if (!userQuery.user) {
                  throw new Error(`未找到用户：${context.repo.owner}`);
                }

                const userId = userQuery.user.id;
                const projects = userQuery.user.projectsV2.nodes || [];
                const existingProject = projects.find(p => p.title === '需求管理');

                let projectId = null;
                if (existingProject) {
                  projectId = existingProject.id;
                  console.log('找到现有项目:', existingProject.title);
                } else {
                  console.log('创建新项目...');
                  // 创建新项目
                  const newProject = await github.graphql(`
                    mutation($input: CreateProjectV2Input!) {
                      createProjectV2(input: $input) {
                        projectV2 {
                          id
                        }
                      }
                    }
                  `, {
                    input: {
                      ownerId: userId,
                      title: '需求管理',
                      repositoryId: null  // 移除这个字段，因为它是可选的
                    }
                  });

                  if (!newProject.createProjectV2) {
                    throw new Error('创建项目失败');
                  }

                  projectId = newProject.createProjectV2.projectV2.id;
                  console.log('新项目已创建');

                  // 创建状态字段
                  try {
                    console.log('创建状态字段...');
                    await github.graphql(`
                      mutation($projectId: ID!) {
                        createProjectV2Field(
                          input: {
                            dataType: SINGLE_SELECT,
                            name: "状态",
                            projectId: $projectId,
                            options: ["待分类", "需求评审", "已接受", "已拒绝", "进行中", "已完成"]
                          }
                        ) {
                          projectField {
                            id
                          }
                        }
                      }
                    `, {
                      projectId: projectId
                    });
                    console.log('状态字段已创建');
                  } catch (fieldError) {
                    console.error('创建状态字段失败:', fieldError);
                    // 继续执行，不中断流程
                  }
                }

                // 将Issue添加到项目
                console.log('添加Issue到项目...');
                const addedItem = await github.graphql(`
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2ItemById(input: {
                      projectId: $projectId
                      contentId: $contentId
                    }) {
                      item {
                        id
                      }
                    }
                  }
                `, {
                  projectId: projectId,
                  contentId: context.payload.issue.node_id
                });

                if (!addedItem.addProjectV2ItemById) {
                  throw new Error('添加Issue到项目失败');
                }

                console.log('Issue已添加到项目');

                // 添加成功评论
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `✅ 此需求已被添加到新版项目看板。\n\n当前处理状态：\n- [x] 发送邮件通知\n- [x] 添加到项目看板\n- [x] 设置评审状态`
                });
              } catch (error) {
                console.error('操作失败:', error);
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `❌ 处理此需求时发生错误: ${error.message}\n\n请确保:\n1. 已正确设置GH_PAT密钥\n2. PAT具有适当的权限（管理项目和Issue权限）\n\n详细错误信息：${error.stack || error.message}`
                });
                throw error;
              }
            }

            // 执行主函数
            await run();
