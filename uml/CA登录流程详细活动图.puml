@startuml CA登录流程详细活动图
!define RECTANGLE class

title CA登录流程详细活动图

|用户|
start
:用户访问系统;
:选择"CA登录"选项;

|浏览器|
:显示CA登录界面;

|用户|
:插入UKey设备;
if (UKey插入成功?) then (否)
  :显示"请插入UKey"提示;
  stop
else (是)
endif

:输入UKey口令;
if (口令输入正确?) then (否)
  :显示"口令错误"提示;
  stop
else (是)
endif

|浏览器|
:读取UKey中的数字证书;
:获取证书信息;
:生成签名数据;
note right: 使用私钥对随机数或时间戳签名

:构造认证请求;
:提交证书信息和签名数据至UUV认证接口;

|UUV代理服务|
:接收认证请求;
:解析证书信息;
:校验签名格式;

if (签名格式正确?) then (否)
  :返回"签名格式错误";
  |浏览器|
  :显示认证失败信息;
  stop
else (是)
endif

:构造CA验证请求;
:转发证书和签名至CA服务器;

|CA服务器|
:接收验证请求;
:验证证书有效性;
note right: 检查证书是否过期、吊销等

if (证书有效?) then (否)
  :返回"证书无效";
else (是)
  :验证签名正确性;
  if (签名正确?) then (否)
    :返回"签名验证失败";
  else (是)
    :返回"认证成功";
  endif
endif

|UUV代理服务|
:接收CA服务器返回结果;
:记录认证日志;

if (CA认证成功?) then (是)
  :生成会话令牌;
  :将认证成功结果和令牌反馈至业务系统;
  
  |业务系统|
  :接收认证成功结果;
  :建立用户会话;
  :完成登录流程;
  
  |浏览器|
  :跳转至系统主页;
  :显示登录成功信息;
  
else (否)
  :将认证失败结果反馈至业务系统;
  
  |业务系统|
  :记录登录失败日志;
  
  |浏览器|
  :显示认证失败信息;
  :提示用户重新尝试;
endif

stop

@enduml
