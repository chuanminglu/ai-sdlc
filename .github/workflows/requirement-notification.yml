name: éœ€æ±‚å˜æ›´é‚®ä»¶é€šçŸ¥

# è§¦å‘æ¡ä»¶ï¼šå½“Issueè¢«åˆ›å»ºã€ç¼–è¾‘ã€æ ‡ç­¾å˜æ›´æˆ–é‡æ–°æ‰“å¼€æ—¶
on:
  issues:
    types: [opened, edited, labeled, unlabeled, reopened]

# GitHub Secrets é…ç½®è¯´æ˜ï¼š
# 1. EMAIL_USERNAME: ä½ çš„QQé‚®ç®±åœ°å€ï¼ˆ52148@qq.comï¼‰
# 2. EMAIL_PASSWORD: ä½ çš„QQé‚®ç®±æˆæƒç ï¼Œä¸æ˜¯QQå¯†ç 
#    è·å–QQé‚®ç®±æˆæƒç æ­¥éª¤ï¼š
#    - ç™»å½•QQé‚®ç®±ç½‘é¡µç‰ˆ
#    - ç‚¹å‡»"è®¾ç½®" -> "è´¦æˆ·"
#    - æ‰¾åˆ°"POP3/SMTPæœåŠ¡"å¹¶å¼€å¯
#    - æŒ‰æç¤ºç”Ÿæˆæˆæƒç å¹¶ä¿å­˜

jobs:
  notify-requirement-change:
    runs-on: ubuntu-latest
    
    # ä»…å½“IssueåŒ…å«"requirement"æˆ–"feature"æ ‡ç­¾æ—¶è¿è¡Œ
    if: contains(github.event.issue.labels.*.name, 'requirement') || contains(github.event.issue.labels.*.name, 'feature')
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç ä»“åº“
      - name: Checkout code
        uses: actions/checkout@v3
      
      # æ­¥éª¤2: å‘é€é‚®ä»¶é€šçŸ¥
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          to: 52148@qq.com
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          subject: ğŸ”” éœ€æ±‚å˜æ›´é€šçŸ¥ï¼š${{ github.event.issue.title }}
          html_body: |
            <h2>éœ€æ±‚å˜æ›´é€šçŸ¥</h2>
            <p><strong>çŠ¶æ€ï¼š</strong> 
            ${{ github.event.action == 'opened' && 'æ–°å¢éœ€æ±‚' ||
                github.event.action == 'edited' && 'éœ€æ±‚å·²ç¼–è¾‘' ||
                github.event.action == 'labeled' && 'éœ€æ±‚æ–°å¢æ ‡ç­¾' ||
                github.event.action == 'unlabeled' && 'éœ€æ±‚ç§»é™¤æ ‡ç­¾' ||
                github.event.action == 'reopened' && 'éœ€æ±‚é‡æ–°æ‰“å¼€' ||
                'éœ€æ±‚å·²æ›´æ–°' }}
            </p>
            <p><strong>æ ‡é¢˜ï¼š</strong> ${{ github.event.issue.title }}</p>
            <p><strong>ç¼–å·ï¼š</strong> #${{ github.event.issue.number }}</p>
            <p><strong>æäº¤è€…ï¼š</strong> ${{ github.event.issue.user.login }}</p>
            <p><strong>æ ‡ç­¾ï¼š</strong> ${{ join(github.event.issue.labels.*.name, ', ') }}</p>
            <h3>éœ€æ±‚æè¿°ï¼š</h3>
            <pre>
            ${{ github.event.issue.body }}
            </pre>
            <p><a href="${{ github.event.issue.html_url }}">æŸ¥çœ‹è¯¦æƒ…</a></p>
      
      # æ­¥éª¤3: æ›´æ–°é¡¹ç›®çœ‹æ¿
      - name: Update project board
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // è·å–é¡¹ç›®ID (ä½¿ç”¨GraphQL API)
            const projectQuery = `
              query {
                repository(owner: "${context.repo.owner}", name: "${context.repo.repo}") {
                  projectsV2(first: 1) {
                    nodes {
                      id
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
              try {
              // å…ˆæ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨
              const projectData = await github.graphql(projectQuery);
              let project = projectData.repository.projectsV2.nodes[0];
              
              // å¦‚æœé¡¹ç›®ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°é¡¹ç›®
              if (!project) {
                console.log('æ­£åœ¨åˆ›å»ºæ–°çš„é¡¹ç›®çœ‹æ¿...');
                const createProjectMutation = `
                  mutation {
                    createProjectV2(input: {
                      ownerId: "${context.repo.owner}",
                      title: "éœ€æ±‚ç®¡ç†",
                      repositoryId: "${context.repo.id}"
                    }) {
                      projectV2 {
                        id
                      }
                    }
                  }
                `;
                
                const createResult = await github.graphql(createProjectMutation);
                project = { id: createResult.createProjectV2.projectV2.id };
                
                // åˆ›å»ºçŠ¶æ€å­—æ®µ
                const createFieldMutation = `
                  mutation {
                    createProjectV2Field(input: {
                      projectId: "${project.id}",
                      dataType: SINGLE_SELECT,
                      name: "çŠ¶æ€",
                      singleSelectOptions: [
                        { name: "å¾…åˆ†ç±»", color: "GRAY" },
                        { name: "éœ€æ±‚è¯„å®¡", color: "YELLOW" },
                        { name: "å·²æ¥å—", color: "GREEN" },
                        { name: "å·²æ‹’ç»", color: "RED" },
                        { name: "è¿›è¡Œä¸­", color: "BLUE" },
                        { name: "å·²å®Œæˆ", color: "PURPLE" }
                      ]
                    }) {
                      projectV2Field {
                        id
                      }
                    }
                  }
                `;
                
                await github.graphql(createFieldMutation);
                console.log('é¡¹ç›®çœ‹æ¿åˆ›å»ºå®Œæˆ');
                
                // é‡æ–°è·å–é¡¹ç›®æ•°æ®
                const refreshData = await github.graphql(projectQuery);
                project = refreshData.repository.projectsV2.nodes[0];
              }
              
              // æŸ¥æ‰¾çŠ¶æ€å­—æ®µ
              const statusField = project.fields.nodes.find(field => 
                field.name.toLowerCase() === "status" || field.name === "çŠ¶æ€"
              );
              
              if (!statusField) {
                console.log('æœªæ‰¾åˆ°çŠ¶æ€å­—æ®µï¼Œå°†ä»…æ·»åŠ åˆ°é¡¹ç›®è€Œä¸è®¾ç½®çŠ¶æ€');
                return;
              }
              
              // æŸ¥æ‰¾"éœ€æ±‚è¯„å®¡"é€‰é¡¹
              const reviewOption = statusField.options.find(option => 
                option.name === "éœ€æ±‚è¯„å®¡"
              );
                // å°†Issueæ·»åŠ åˆ°é¡¹ç›®
              const addToProjectMutation = `
                mutation {
                  addProjectV2ItemById(input: {
                    projectId: "${project.id}"
                    contentId: "${github.event.issue.node_id}"
                  }) {
                    item {
                      id
                    }
                  }
                }
              `;
              
              const result = await github.graphql(addToProjectMutation);
              const itemId = result.addProjectV2ItemById.item.id;
              
              // è®¾ç½®çŠ¶æ€ä¸º"éœ€æ±‚è¯„å®¡"
              if (reviewOption) {
                const updateFieldMutation = `
                  mutation {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: "${project.id}"
                      itemId: "${itemId}"
                      fieldId: "${statusField.id}"
                      value: { 
                        singleSelectOptionId: "${reviewOption.id}"
                      }
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `;
                
                await github.graphql(updateFieldMutation);
              }
              
              // æ·»åŠ è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âœ… æ­¤éœ€æ±‚å·²è¢«æ·»åŠ åˆ°é¡¹ç›®çœ‹æ¿å¹¶æ ‡è®°ä¸º"éœ€æ±‚è¯„å®¡"çŠ¶æ€ã€‚\n\nå½“å‰å¤„ç†çŠ¶æ€ï¼š\n- [x] å‘é€é‚®ä»¶é€šçŸ¥\n- [x] æ·»åŠ åˆ°é¡¹ç›®çœ‹æ¿\n- [x] è®¾ç½®è¯„å®¡çŠ¶æ€`
              });
              
            } catch (error) {
              console.log(`æ›´æ–°é¡¹ç›®çœ‹æ¿å¤±è´¥: ${error.message}`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ å°è¯•æ·»åŠ æ­¤éœ€æ±‚åˆ°é¡¹ç›®çœ‹æ¿æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`
              });
            }
