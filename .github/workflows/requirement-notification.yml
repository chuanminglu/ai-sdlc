name: éœ€æ±‚å˜æ›´é‚®ä»¶é€šçŸ¥

# è§¦å‘æ¡ä»¶ï¼šå½“Issueè¢«åˆ›å»ºã€ç¼–è¾‘ã€æ ‡ç­¾å˜æ›´æˆ–é‡æ–°æ‰“å¼€æ—¶
on:
  issues:
    types: [opened, edited, labeled, unlabeled, reopened]

permissions:
  contents: read    # ç”¨äºè¯»å–ä»“åº“å†…å®¹
  issues: write     # ç”¨äºåˆ›å»ºå’Œè¯„è®ºIssue
  pull-requests: read # ç”¨äºè¯»å–ä»“åº“å…ƒæ•°æ®
  repository-projects: write # ç”¨äºç®¡ç†é¡¹ç›®

# GitHub Secrets é…ç½®è¯´æ˜ï¼š
# 1. EMAIL_USERNAME: ä½ çš„QQé‚®ç®±åœ°å€ï¼ˆ52148@qq.comï¼‰
# 2. EMAIL_PASSWORD: ä½ çš„QQé‚®ç®±æˆæƒç ï¼Œä¸æ˜¯QQå¯†ç 
#    è·å–QQé‚®ç®±æˆæƒç æ­¥éª¤ï¼š
#    - ç™»å½•QQé‚®ç®±ç½‘é¡µç‰ˆ
#    - ç‚¹å‡»"è®¾ç½®" -> "è´¦æˆ·"
#    - æ‰¾åˆ°"POP3/SMTPæœåŠ¡"å¹¶å¼€å¯
#    - æŒ‰æç¤ºç”Ÿæˆæˆæƒç å¹¶ä¿å­˜

jobs:
  notify-requirement-change:
    runs-on: ubuntu-latest
    
    # ä»…å½“IssueåŒ…å«"requirement"æˆ–"feature"æ ‡ç­¾æ—¶è¿è¡Œ
    if: contains(github.event.issue.labels.*.name, 'requirement') || contains(github.event.issue.labels.*.name, 'feature')
    
    steps:
      # æ­¥éª¤1: å‘é€é‚®ä»¶é€šçŸ¥
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          to: 52148@qq.com
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          subject: ğŸ”” éœ€æ±‚å˜æ›´é€šçŸ¥ï¼š${{ github.event.issue.title }}
          html_body: |
            <h2>éœ€æ±‚å˜æ›´é€šçŸ¥</h2>
            <p><strong>çŠ¶æ€ï¼š</strong> 
            ${{ github.event.action == 'opened' && 'æ–°å¢éœ€æ±‚' ||
                github.event.action == 'edited' && 'éœ€æ±‚å·²ç¼–è¾‘' ||
                github.event.action == 'labeled' && 'éœ€æ±‚æ–°å¢æ ‡ç­¾' ||
                github.event.action == 'unlabeled' && 'éœ€æ±‚ç§»é™¤æ ‡ç­¾' ||
                github.event.action == 'reopened' && 'éœ€æ±‚é‡æ–°æ‰“å¼€' ||
                'éœ€æ±‚å·²æ›´æ–°' }}
            </p>
            <p><strong>æ ‡é¢˜ï¼š</strong> ${{ github.event.issue.title }}</p>
            <p><strong>ç¼–å·ï¼š</strong> #${{ github.event.issue.number }}</p>
            <p><strong>æäº¤è€…ï¼š</strong> ${{ github.event.issue.user.login }}</p>
            <p><strong>æ ‡ç­¾ï¼š</strong> ${{ join(github.event.issue.labels.*.name, ', ') }}</p>
            <h3>éœ€æ±‚æè¿°ï¼š</h3>
            <pre>
            ${{ github.event.issue.body }}
            </pre>
            <p><a href="${{ github.event.issue.html_url }}">æŸ¥çœ‹è¯¦æƒ…</a></p>
      
      # æ­¥éª¤2: æ›´æ–°é¡¹ç›®çœ‹æ¿ï¼ˆä½¿ç”¨æ–°ç‰ˆ GitHub Projects APIï¼‰
      - name: Update project board
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_PAT }}  # ä½¿ç”¨å…·æœ‰æ›´é«˜æƒé™çš„ä¸ªäººè®¿é—®ä»¤ç‰Œ
          script: |
            async function run() {
              try {
                // é¦–å…ˆè·å–ç”¨æˆ·çš„èŠ‚ç‚¹ID
                const userQuery = await github.graphql(`
                  query($owner: String!) {
                    user(login: $owner) {
                      id
                      projectsV2(first: 20) {
                        nodes {
                          id
                          title
                          number
                        }
                      }
                    }
                  }
                `, {
                  owner: context.repo.owner
                });

                if (!userQuery.user) {
                  throw new Error(`æœªæ‰¾åˆ°ç”¨æˆ·ï¼š${context.repo.owner}`);
                }

                const userId = userQuery.user.id;
                const projects = userQuery.user.projectsV2.nodes || [];
                const existingProject = projects.find(p => p.title === 'éœ€æ±‚ç®¡ç†');

                let projectId = null;
                if (existingProject) {
                  projectId = existingProject.id;
                  console.log('æ‰¾åˆ°ç°æœ‰é¡¹ç›®:', existingProject.title);
                } else {
                  console.log('åˆ›å»ºæ–°é¡¹ç›®...');
                  // åˆ›å»ºæ–°é¡¹ç›®
                  const newProject = await github.graphql(`
                    mutation($input: CreateProjectV2Input!) {
                      createProjectV2(input: $input) {
                        projectV2 {
                          id
                        }
                      }
                    }
                  `, {
                    input: {
                      ownerId: userId,
                      title: 'éœ€æ±‚ç®¡ç†',
                      repositoryId: null  // ç§»é™¤è¿™ä¸ªå­—æ®µï¼Œå› ä¸ºå®ƒæ˜¯å¯é€‰çš„
                    }
                  });

                  if (!newProject.createProjectV2) {
                    throw new Error('åˆ›å»ºé¡¹ç›®å¤±è´¥');
                  }

                  projectId = newProject.createProjectV2.projectV2.id;
                  console.log('æ–°é¡¹ç›®å·²åˆ›å»º');

                  // åˆ›å»ºçŠ¶æ€å­—æ®µ
                  try {
                    console.log('åˆ›å»ºçŠ¶æ€å­—æ®µ...');
                    await github.graphql(`
                      mutation($projectId: ID!) {
                        createProjectV2Field(
                          input: {
                            dataType: SINGLE_SELECT,
                            name: "çŠ¶æ€",
                            projectId: $projectId,
                            options: ["å¾…åˆ†ç±»", "éœ€æ±‚è¯„å®¡", "å·²æ¥å—", "å·²æ‹’ç»", "è¿›è¡Œä¸­", "å·²å®Œæˆ"]
                          }
                        ) {
                          projectField {
                            id
                          }
                        }
                      }
                    `, {
                      projectId: projectId
                    });
                    console.log('çŠ¶æ€å­—æ®µå·²åˆ›å»º');
                  } catch (fieldError) {
                    console.error('åˆ›å»ºçŠ¶æ€å­—æ®µå¤±è´¥:', fieldError);
                    // ç»§ç»­æ‰§è¡Œï¼Œä¸ä¸­æ–­æµç¨‹
                  }
                }

                // å°†Issueæ·»åŠ åˆ°é¡¹ç›®
                console.log('æ·»åŠ Issueåˆ°é¡¹ç›®...');
                const addedItem = await github.graphql(`
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2ItemById(input: {
                      projectId: $projectId
                      contentId: $contentId
                    }) {
                      item {
                        id
                      }
                    }
                  }
                `, {
                  projectId: projectId,
                  contentId: context.payload.issue.node_id
                });

                if (!addedItem.addProjectV2ItemById) {
                  throw new Error('æ·»åŠ Issueåˆ°é¡¹ç›®å¤±è´¥');
                }

                console.log('Issueå·²æ·»åŠ åˆ°é¡¹ç›®');

                // æ·»åŠ æˆåŠŸè¯„è®º
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `âœ… æ­¤éœ€æ±‚å·²è¢«æ·»åŠ åˆ°æ–°ç‰ˆé¡¹ç›®çœ‹æ¿ã€‚\n\nå½“å‰å¤„ç†çŠ¶æ€ï¼š\n- [x] å‘é€é‚®ä»¶é€šçŸ¥\n- [x] æ·»åŠ åˆ°é¡¹ç›®çœ‹æ¿\n- [x] è®¾ç½®è¯„å®¡çŠ¶æ€`
                });
              } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `âŒ å¤„ç†æ­¤éœ€æ±‚æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}\n\nè¯·ç¡®ä¿:\n1. å·²æ­£ç¡®è®¾ç½®GH_PATå¯†é’¥\n2. PATå…·æœ‰é€‚å½“çš„æƒé™ï¼ˆç®¡ç†é¡¹ç›®å’ŒIssueæƒé™ï¼‰\n\nè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š${error.stack || error.message}`
                });
                throw error;
              }
            }

            // æ‰§è¡Œä¸»å‡½æ•°
            await run();
